<div class="worldMap">
  @if (isStepFormVisible()) {
    <div class="create-step-modal">
      <div class="create-step-modal__panel">
        <div class="create-step-modal__header">
          <div>
            @if (isEditingStep()) {
              <h2>Modifier l'étape</h2>
              <p>Mettez à jour les informations de cette étape.</p>
            } @else {
              <h2>Ajouter une étape</h2>
              <p>Complétez les informations de votre nouvelle étape.</p>
            }
          </div>
          <button
            type="button"
            class="create-step-modal__close"
            (click)="onStepFormCancel()"
            aria-label="Fermer la création d'étape"
          >
            <app-icon name="close"></app-icon>
          </button>
        </div>

        <app-create-step-form
          [isSubmitting]="isStepSubmitting()"
          [errorMessage]="stepFormError()"
          [availableThemes]="stepThemes()"
          (cancel)="onStepFormCancel()"
          (submitStep)="onStepFormSubmit($event)"
        ></app-create-step-form>
      </div>
    </div>
  }
  <div
    #detailPanel
    class="worldMap__detail-panel"
    [ngClass]="isTabletOrMobile() ? state.panelHeight() : ''"
  >
    @if (isTabletOrMobile()) {
      <div class="worldMap__detail-divider" (click)="togglePanel()">
        <app-divider thickness="thick" radius="15"></app-divider>
      </div>
    }
    @if (state.currentDiary()) {
      <div class="worldMap__detail-panel__header worldMap__header__diary">
        <div
          class="diary__cover"
          [style]="`background-image: url(${getDiaryCover()})`"
        >
          @let diaryOwner = diaryOwnerInfo();
          @if (diaryOwner) {
            <button
              type="button"
              class="diary__avatar"
              (click)="onOwnerNavigate(diaryOwner)"
              [attr.aria-label]="getOwnerLinkAriaLabel(diaryOwner)"
            >
              <app-avatar
                [label]="diaryOwner.label || 'Utilisateur'"
                [picture]="diaryOwner.avatar ?? undefined"
                [style.cursor]="'pointer'"
              ></app-avatar>
            </button>
          } @else {
            <div class="diary__avatar">
              <app-avatar label="Utilisateur"></app-avatar>
            </div>
          }
          <h1 class="worldMap__detail-panel__header--title">{{ state.currentDiary()?.title }}</h1>
          <p>Mettre des stats ?</p>
        </div>
      </div>
    }

    <div class="worldMap__detail-panel__body">
      @if (state.currentDiary()) {
        <div class="worldMap__detail-panel__body--progress-bar progress-bar--sticky">
          <app-progress-bar
            [completedSteps]="state.completedSteps()"
            [totalSteps]="state.totalStepsCount()"
          />
        </div>
      }
      <div class="worldMap__detail-panel__body--steps-container">
        @let viewerIsOwner = isDiaryOwner();
        @if (viewerIsOwner) {
          <div class="diary__actions">
            <app-button
              text="Créer une étape"
              color="primary"
              size="auto"
              radius="border_lg"
              (btnClick)="onCreateStepClick()"
              [isDisabled]="isStepFormVisible()"
              data-test="diary-add-step"
            ></app-button>
          </div>
        }
        @for (step of state.steps(); track $index) {
          @let medias = getStepMedias(step);
          <div class="worldMap__step" [attr.data-test]="'diary-step-' + step.id">
            <app-accordion
              [id]="step.id"
              [title]="step.title"
              [subTitle]="step.country"
              [startDate]="step.startDate ?? undefined"
              [isOpen]="state.openedStepId() === step.id"
              (toggleOpen)="onAccordionToggle(step.id, $event)"
              (stepClicked)="onStepClicked($event)"
              (remove)="onDeleteSteps(step.id)"
              [role]="viewerIsOwner ? 'owner' : 'reader'"
              [(isEditing)]="step.isEditing"
              (isEditingChange)="onStepEditModeChange(step, $event)"
              [dataTest]="'step-accordion-' + step.id"
              [editDataTest]="'step-edit-' + step.id"
              [deleteDataTest]="'step-delete-' + step.id"
            >
            <div class="step__content__container">
              <div
                class="step__content ql-editor"
                [innerHTML]="step.description | safeHtml"
              ></div>

              <div class="step__media__wrapper">
                @if (medias.length > 1) {
                  <button
                    class="scroll-btn scroll-btn--left"
                    (click)="scrollMediaContainer(step.id, 'left')"
                  >
                    ←
                  </button>
                }

                <div class="step__media__container" [attr.data-id]="step.id">
                  @for (media of medias; track $index) {
                    <img
                      [src]="getStepMediaUrl(media)"
                      sizes="100vw"
                      loading="lazy"
                      decoding="async"
                      alt=""
                    />
                  }
                </div>

                @if (medias.length > 1) {
                  <button
                    class="scroll-btn scroll-btn--right"
                    (click)="scrollMediaContainer(step.id, 'right')"
                  >
                    →
                  </button>
                }
              </div>

              <div class="step__action__btn">
                <app-button
                  [startIcon]="true"
                  [icon]="step.viewerHasLiked ? 'favorite' : 'favorite_border'"
                  type="like"
                  [text]="formatLikeLabel(step)"
                  [isDisabled]="isStepLikePending(step.id)"
                  (btnClick)="handleButtonClick($event, step)"
                ></app-button>
                <app-button
                  [startIcon]="true"
                  icon="chat_bubble"
                  type="comment"
                  text="{{ getCommentLabel(step) }}"
                  (btnClick)="handleButtonClick($event, step)"
                ></app-button>
              </div>
              @if (getStepLikeError(step.id)) {
                <p class="step__like-error">{{ getStepLikeError(step.id) }}</p>
              }
              <!-- ✅ Ici on affiche si le step correspond -->
              @if (state.openedCommentStepId() === step.id) {
                <div class="step_comments">
                  @if (step.comments?.length) {
                    @for (comment of step.comments; track $index) {
                      <div
                        class="step_comments__container"
                        [ngClass]="{
                          'step_comments__container--left': $index % 2 === 0,
                          'step_comments__container--right': $index % 2 !== 0,
                        }"
                      >
                        <p class="step_comment__user">
                          {{ getCommentAuthor(comment) }}
                          <span class="step_comment__date">{{
                            comment.updatedAt | date: 'dd/MM/yyyy'
                          }}</span>
                        </p>
                        @if (isCommentEditing(comment.id)) {
                          <form
                            class="step_comment__edit-form"
                            (ngSubmit)="onSubmitCommentEdit(step, comment)"
                          >
                            <textarea
                              rows="3"
                              [ngModel]="getCommentEditDraft(comment.id)"
                              (ngModelChange)="onCommentEditDraftChange(comment.id, $event)"
                              name="edit-comment-{{ comment.id }}"
                              [disabled]="isCommentUpdating(comment.id)"
                            ></textarea>

                            @if (getCommentEditError(comment.id)) {
                              <p class="step_comment__error">{{
                                getCommentEditError(comment.id)
                              }}</p>
                            }

                            <div class="step_comment__actions">
                              <button
                                type="button"
                                class="step_comment__action"
                                (click)="onCancelCommentEdit()"
                                [disabled]="isCommentUpdating(comment.id)"
                              >
                                Annuler
                              </button>
                              <button
                                type="submit"
                                class="step_comment__action step_comment__action--primary"
                                [disabled]="isCommentUpdating(comment.id)"
                              >
                                Enregistrer
                              </button>
                            </div>
                          </form>
                        } @else {
                          <p class="step_comment__content">{{ comment.content }}</p>
                        }

                        @if (canManageComment(comment) && !isCommentEditing(comment.id)) {
                          <div class="step_comment__footer">
                            <button
                              type="button"
                              class="step_comment__action"
                              (click)="onEditComment(step, comment)"
                              [disabled]="isCommentDeleting(comment.id) || isCommentEditing(comment.id)"
                            >
                              Modifier
                            </button>
                            <button
                              type="button"
                              class="step_comment__action step_comment__action--danger"
                              (click)="onDeleteComment(step, comment)"
                              [disabled]="isCommentDeleting(comment.id)"
                            >
                              Supprimer
                            </button>
                          </div>
                        }
                      </div>
                    }
                  } @else {
                    <p>Aucun commentaire pour le moment.</p>
                  }

                  @if (!canDiaryReceiveComments()) {
                    <p class="step_comment__message">
                      Les commentaires sont désactivés pour ce carnet.
                    </p>
                  } @else if (!isAuthenticated()) {
                    <p class="step_comment__message">
                      Connectez-vous pour commenter cette étape.
                    </p>
                  } @else if (isViewerDisabled()) {
                    <p class="step_comment__message">
                      Votre compte est désactivé. Vous ne pouvez plus commenter cette étape.
                    </p>
                  } @else {
                    <form class="step_comment__form" (ngSubmit)="onSubmitComment(step)">
                      <label class="visually-hidden" [for]="'comment-' + step.id">
                        Ajouter un commentaire pour {{ step.title }}
                      </label>
                      <textarea
                        [id]="'comment-' + step.id"
                        name="comment-{{ step.id }}"
                        rows="3"
                        placeholder="Écrire un commentaire..."
                        [ngModel]="getCommentDraft(step.id)"
                        (ngModelChange)="onCommentDraftChange(step.id, $event)"
                        [disabled]="isCommentSubmitting(step.id)"
                      ></textarea>

                      @if (getCommentError(step.id)) {
                        <p class="step_comment__error">{{ getCommentError(step.id) }}</p>
                      }

                      <app-button
                        text="Publier"
                        color="primary"
                        type="standard"
                        htmlType="submit"
                        [isDisabled]="isCommentSubmitting(step.id)"
                      ></app-button>
                    </form>
                  }
                </div>
              }
            </div>
            </app-accordion>
          </div>
        }
      </div>
    </div>
  </div>
</div>
