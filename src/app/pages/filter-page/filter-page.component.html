<div class="worldMap">
  <div
    #detailPanel
    class="worldMap__detail-panel"
    [ngClass]="isTabletOrMobile() ? state.panelHeight() : ''"
  >
    @if (isTabletOrMobile()) {
      <div class="worldMap__detail-divider" (click)="togglePanel()">
        <app-divider thickness="thick" radius="15"></app-divider>
      </div>

      @if (!state.currentDiary() || router.url === '/travels') {
        <app-search-bar
          [control]="searchControl"
          placeholder="Rechercher un carnet ou une étape"
          dataTestId="filter-panel-search-input"
          size="compact"
          (searchSubmit)="onSearchSubmit($event)"
          (clear)="onClearSearchClick()"
        />
      }
    }
    @if (!isTabletOrMobile()) {
      <div class="worldMap__detail-panel__header worldMap__header__filter">
        <app-icon name="search" color="primary" size="xl"></app-icon>
        <h1 class="worldMap__detail-panel__header--title">Lieux à explorer</h1>
        <div class="iconContainer arrow">
          <img src="icon/arrow_down.svg" />
        </div>
      </div>
    }

    <div class="worldMap__detail-panel__body">
      @if (hasActiveSearch()) {
        <section class="worldMap__search-results">
          <header class="worldMap__search-results__header">
            <h2>Résultats pour « {{ activeSearchQuery() }} »</h2>
            <button type="button" (click)="clearSearchQuery()">Effacer</button>
          </header>
          @if (isSearchLoading()) {
            <p class="worldMap__search-results__status">Recherche en cours…</p>
          } @else if (searchError()) {
            <p class="worldMap__search-results__status worldMap__search-results__status--error">
              {{ searchError() }}
            </p>
          } @else if (noSearchResults()) {
            <p class="worldMap__search-results__status">Aucun résultat disponible.</p>
          } @else {
            @if (diaryResults().length) {
              <section class="worldMap__search-results__group">
                <h3>Carnets</h3>
                <ul>
                  @for (result of diaryResults(); track result.id) {
                    <li>
                      <button type="button" (click)="onSearchResultClick(result)">
                        <span class="label">{{ result.label }}</span>
                        @if (result.description) {
                          <span class="description">{{ result.description }}</span>
                        }
                      </button>
                    </li>
                  }
                </ul>
              </section>
            }
            @if (stepResults().length) {
              <section class="worldMap__search-results__group">
                <h3>Étapes</h3>
                <ul>
                  @for (result of stepResults(); track result.id) {
                    <li>
                      <button type="button" (click)="onSearchResultClick(result)">
                        <span class="label">{{ result.label }}</span>
                        <span class="description">
                          @if (result.diaryTitle) {
                            {{ result.diaryTitle }} ·
                          }
                          {{ result.description ?? 'Voir le détail' }}
                        </span>
                      </button>
                    </li>
                  }
                </ul>
              </section>
            }
          }
        </section>
      }
      <section class="worldMap__filtered-results">
        <header class="worldMap__filtered-results__header">
          <h2>
            Carnets filtrés
            <span>({{ filteredDiaries().length }})</span>
          </h2>
          @if (hasActiveFilters()) {
            <button type="button" (click)="resetFilters()">Réinitialiser</button>
          }
        </header>
        @if (!hasActiveFilters()) {
          <p class="worldMap__filtered-results__status">
            Sélectionnez un filtre pour afficher les carnets correspondants.
          </p>
        } @else if (!filteredDiaries().length) {
          <p class="worldMap__filtered-results__status">
            Aucun carnet ne correspond aux filtres sélectionnés.
          </p>
        } @else {
          <ul class="worldMap__filtered-results__list">
            @for (diary of filteredDiaries(); track diary.id) {
              <li>
                <button type="button" (click)="onFilteredDiaryClick(diary.id)">
                  <span class="label">{{ diary.title }}</span>
                  @let meta = getDiaryMeta(diary.id);
                  @let durationLabel = getDurationLabel(meta?.durationId ?? null);
                  @if (meta?.countries?.length) {
                    <span class="description">Pays : {{ meta?.countries?.join(', ') }}</span>
                  }
                  @if (meta?.continents?.length) {
                    <span class="description">
                      Continents : {{ meta?.continents?.join(', ') }}
                    </span>
                  }
                  @if (meta?.themes?.length) {
                    <span class="description">Thèmes : {{ meta?.themes?.join(', ') }}</span>
                  }
                  @if (durationLabel) {
                    <span class="description">Durée : {{ durationLabel }}</span>
                  }
                </button>
              </li>
            }
          </ul>
        }
      </section>
      <div class="worldMap__filter-panel">
        <app-accordion [isFilter]="true" title="Pays">
          <div class="filter__container">
            @if (countryOptions().length) {
              @for (option of countryOptions(); track option.value) {
                <app-checkbox
                  [checkboxName]="buildCheckboxId('countries', option.value)"
                  [label]="formatFilterLabel(option)"
                  [checked]="isFilterSelected('countries', option.value)"
                  (checkedChange)="onFilterChecked('countries', option.value, $event)"
                ></app-checkbox>
              }
            } @else {
              <p class="filter__empty">Aucun pays disponible</p>
            }
          </div>
        </app-accordion>
        <app-accordion [isFilter]="true" title="Continent">
          <div class="filter__container">
            @if (continentOptions().length) {
              @for (option of continentOptions(); track option.value) {
                <app-checkbox
                  [checkboxName]="buildCheckboxId('continents', option.value)"
                  [label]="formatFilterLabel(option)"
                  [checked]="isFilterSelected('continents', option.value)"
                  (checkedChange)="onFilterChecked('continents', option.value, $event)"
                ></app-checkbox>
              }
            } @else {
              <p class="filter__empty">Aucun continent disponible</p>
            }
          </div>
        </app-accordion>
        <app-accordion [isFilter]="true" title="Durée">
          <div class="filter__container">
            @if (durationOptions().length) {
              @for (option of durationOptions(); track option.value) {
                <app-checkbox
                  [checkboxName]="buildCheckboxId('durations', option.value)"
                  [label]="formatFilterLabel(option)"
                  [checked]="isFilterSelected('durations', option.value)"
                  (checkedChange)="onFilterChecked('durations', option.value, $event)"
                ></app-checkbox>
              }
            } @else {
              <p class="filter__empty">Aucune durée disponible</p>
            }
          </div>
        </app-accordion>
        <app-accordion [isFilter]="true" title="Themes">
          <div class="filter__container">
            @if (themeOptions().length) {
              @for (option of themeOptions(); track option.value) {
                <app-checkbox
                  [checkboxName]="buildCheckboxId('themes', option.value)"
                  [label]="formatFilterLabel(option)"
                  [checked]="isFilterSelected('themes', option.value)"
                  (checkedChange)="onFilterChecked('themes', option.value, $event)"
                ></app-checkbox>
              }
            } @else {
              <p class="filter__empty">Aucun thème disponible</p>
            }
          </div>
        </app-accordion>
      </div>
    </div>
  </div>
</div>
