<div class="create-diary-modal" [class.create-diary-modal--mobile]="isMobile" data-test="create-diary-modal">
  <div class="create-diary-modal__panel">
    <div class="create-diary-modal__header">
      <div>
        <h2>
          @if (stage === 'diary') {
            Créer un carnet
          } @else {
            Ajouter votre première étape
          }
        </h2>
        <p>
          @if (stage === 'diary') {
            Saisissez les informations principales de votre voyage.
          } @else {
            @let diaryTitle = diaryForm.get('title')?.value;
            @if (diaryTitle) {
              Première étape pour « {{ diaryTitle }} »
            } @else {
              Décrivez la première étape de votre voyage.
            }
          }
        </p>
      </div>
      <button
        type="button"
        class="create-diary-modal__close"
        (click)="handleCancel()"
        aria-label="Fermer"
      >
        <app-icon name="close"></app-icon>
      </button>
    </div>

    @if (stage === 'diary') {
      <form
        class="create-diary-modal__form"
        [formGroup]="diaryForm"
        (ngSubmit)="handleDiarySubmit()"
        data-test="create-diary-form"
      >
        <section class="create-diary-modal__section">
          <h3>Informations du carnet</h3>
          <div class="create-diary-modal__grid create-diary-modal__grid--diary">
            <app-text-input
              formControlName="title"
              label="Nom du voyage"
              placeholder="Le nom de votre voyage"
              [isRequired]="true"
              [errorMessage]="getDiaryControlError('title')"
              data-test="create-diary-title"
            ></app-text-input>

            <app-text-input
              formControlName="startDate"
              label="Date de début de voyage"
              placeholder="Choisissez la date de départ"
              type="date"
              [isRequired]="true"
              [errorMessage]="getDiaryControlError('startDate')"
              data-test="create-diary-period"
            ></app-text-input>
          </div>

          <div class="create-diary-modal__card create-diary-modal__card--stack">
            <div class="create-diary-modal__card-header">
              <app-icon name="travel_explore"></app-icon>
              <div>
                <p class="create-diary-modal__card-title">Image de couverture</p>
                <p class="create-diary-modal__card-subtitle">
                  Ajoutez un visuel pour présenter votre carnet.
                </p>
              </div>
            </div>

            <app-text-input
              formControlName="coverUrl"
              label="Adresse de l'image (URL)"
              placeholder="https://"
              data-test="create-diary-cover"
            ></app-text-input>

            <div class="create-diary-modal__upload">
              <input
                #coverFileInput
                type="file"
                accept="image/*"
                (change)="onCoverFileSelected($event)"
                hidden
              />
              <app-button
                text="Importer une image"
                color="secondary"
                size="auto"
                radius="border_lg"
                htmlType="button"
                [isDisabled]="isCoverUploading || isSubmitting"
                (btnClick)="coverFileInput.click()"
                data-test="create-diary-cover-upload"
              ></app-button>
              <p class="create-diary-modal__upload-hint">
                Choisissez un fichier pour téléverser via Cloudinary. L'URL est mise à jour
                automatiquement.
              </p>
              @if (isCoverUploading) {
                <p class="create-diary-modal__upload-status">Téléversement en cours…</p>
              }
              @if (coverUploadError) {
                <p class="create-diary-modal__upload-error">{{ coverUploadError }}</p>
              }
            </div>
          </div>

          <div class="create-diary-modal__options" role="group" aria-label="Paramètres du carnet">
            <label class="create-diary-modal__option" data-test="create-diary-private">
              <input type="checkbox" formControlName="isPrivate" />
              <span class="create-diary-modal__option-icon">
                <app-icon [name]="diaryForm.get('isPrivate')?.value ? 'lock' : 'public'"></app-icon>
              </span>
              <span class="create-diary-modal__option-content">
                <span class="create-diary-modal__option-title">
                  Carnet {{ diaryForm.get('isPrivate')?.value ? 'privé' : 'public' }}
                </span>
                <span class="create-diary-modal__option-hint">
                  Appuyez pour {{ diaryForm.get('isPrivate')?.value ? 'le rendre public' : 'le rendre privé' }}.
                </span>
              </span>
            </label>
            <label class="create-diary-modal__option" data-test="create-diary-comments">
              <input type="checkbox" formControlName="canComment" />
              <span class="create-diary-modal__option-icon">
                <app-icon [name]="diaryForm.get('canComment')?.value ? 'chat_bubble' : 'chat_bubble_outline'"></app-icon>
              </span>
              <span class="create-diary-modal__option-content">
                <span class="create-diary-modal__option-title">
                  Commentaires {{ diaryForm.get('canComment')?.value ? 'activés' : 'désactivés' }}
                </span>
                <span class="create-diary-modal__option-hint">
                  Autorisez les lecteurs à réagir au carnet.
                </span>
              </span>
            </label>
          </div>

          <div class="create-diary-modal__editor">
            <app-editor
              [label]="'Décrivez votre voyage'"
              [content]="diaryEditorContent"
              (contentChange)="onDiaryEditorChange($event)"
            ></app-editor>
          </div>
        </section>

        <div class="create-diary-modal__footer">
          <app-button
            text="Annuler"
            color="secondary"
            size="auto"
            radius="border_lg"
            htmlType="button"
            [isDisabled]="isSubmitting"
            (btnClick)="handleCancel()"
            data-test="create-diary-cancel"
          ></app-button>
          @if (mode === 'edit') {
            <app-button
              text="Enregistrer le carnet"
              color="primary"
              size="auto"
              radius="border_lg"
              htmlType="submit"
              [isDisabled]="diaryForm.invalid || isSubmitting || isCoverUploading"
              data-test="create-diary-submit"
            ></app-button>
          } @else {
            <app-button
              text="Continuer"
              color="primary"
              size="auto"
              radius="border_lg"
              htmlType="submit"
              [isDisabled]="diaryForm.invalid || isSubmitting || isCoverUploading"
              data-test="create-diary-continue"
            ></app-button>
          }
        </div>
      </form>
    }

    @if (stage === 'step' && mode !== 'edit') {
      <form
        class="create-diary-modal__form"
        [formGroup]="stepForm"
        (ngSubmit)="handleStepSubmit()"
        data-test="create-first-step-form"
      >
        <section class="create-diary-modal__section">
          <h3>Première étape</h3>
          <div class="create-diary-modal__grid create-diary-modal__grid--step-primary">
            <app-text-input
              formControlName="title"
              label="Nom de l'étape"
              placeholder="Nom de l'étape"
              [isRequired]="true"
              [errorMessage]="getStepControlError('title')"
              data-test="create-step-title"
            ></app-text-input>

            <app-text-input
              formControlName="startDate"
              label="Début de l'étape"
              placeholder="Date et heure"
              type="date"
              [isRequired]="true"
              [errorMessage]="getStepControlError('startDate')"
              data-test="create-step-start"
            ></app-text-input>

            <app-text-input
              formControlName="endDate"
              label="Fin de l'étape"
              placeholder="Date et heure"
              type="date"
              [isRequired]="true"
              [errorMessage]="getStepControlError('endDate')"
              data-test="create-step-end"
            ></app-text-input>
          </div>

          <div class="create-diary-modal__grid create-diary-modal__grid--step-location">
            <app-text-input
              formControlName="city"
              label="Ville"
              placeholder="Ville"
              [isDisabled]="true"
              data-test="create-step-city"
            ></app-text-input>
            <app-text-input
              formControlName="country"
              label="Pays"
              placeholder="Pays"
              [isDisabled]="true"
              data-test="create-step-country"
            ></app-text-input>
            <app-text-input
              formControlName="continent"
              label="Continent"
              placeholder="Continent"
              [isDisabled]="true"
              data-test="create-step-continent"
            ></app-text-input>
          </div>

          <div class="create-diary-modal__grid create-diary-modal__grid--step-meta">
            <div class="create-diary-modal__card create-diary-modal__card--inline create-diary-modal__card--location">
              <div class="create-diary-modal__card-header">
                <app-icon name="location_on"></app-icon>
                <div>
                  <p class="create-diary-modal__card-title">Localisation</p>
                  <p class="create-diary-modal__card-subtitle">
                    Sélectionnez le lieu de cette étape directement sur la carte.
                  </p>
                </div>
              </div>

            <div class="create-diary-modal__location-actions">
              <app-button
                text="Choisir sur la carte"
                color="secondary"
                  size="auto"
                  radius="border_lg"
                  htmlType="button"
                  (btnClick)="openStepLocationModal()"
                  data-test="create-step-location"
                ></app-button>
                <span class="create-diary-modal__location-summary">{{
                  stepLocationSummary || stepSelectedCoordinatesSummary
                }}</span>
              </div>
              @if (isStepGeocoding) {
                <p class="create-diary-modal__location-status">Recherche de l'adresse…</p>
              }
              @if (stepGeocodingError) {
                <p class="create-diary-modal__location-error">{{ stepGeocodingError }}</p>
              }
              @if (stepShowLocationRequiredMessage) {
                <p class="create-diary-modal__location-error">
                  Sélectionnez un point sur la carte pour continuer.
                </p>
              }
              <input type="hidden" formControlName="latitude" />
              <input type="hidden" formControlName="longitude" />
            </div>

            <div class="create-diary-modal__card create-diary-modal__card--inline create-diary-modal__card--theme">
              <div class="create-diary-modal__card-header">
                <app-icon name="style"></app-icon>
                <div>
                  <p class="create-diary-modal__card-title">Thèmes</p>
                  <p class="create-diary-modal__card-subtitle">
                    Associez une ambiance à cette escale.
                  </p>
                </div>
              </div>
              <app-select
                class="create-diary-modal__theme-select"
                [itemsList]="availableThemes"
                label=""
                placeholder="Choisissez un thème"
                [withMutipleSelect]="true"
                [selectedIds]="stepForm.get('themeIds')?.value ?? []"
                [disabled]="availableThemes.length === 0"
                (selectOnChange)="onThemeChange($event)"
                data-test="create-step-themes"
              ></app-select>
            </div>
          </div>

          <div class="create-diary-modal__card create-diary-modal__card--media">
            <div class="create-diary-modal__card-header">
              <app-icon name="photo_library"></app-icon>
              <div>
                <p class="create-diary-modal__card-title">Galerie de l'étape</p>
                <p class="create-diary-modal__card-subtitle">
                  Importez vos souvenirs pour les afficher côte à côte.
                </p>
              </div>
            </div>
            <app-media-grid-uploader
              class="create-diary-modal__media-uploader"
              [items]="stepMediaItems"
              [folder]="'travel-diaries/steps'"
              (itemsChange)="onStepMediaItemsChange($event)"
              (primaryChange)="onStepPrimaryMediaChange($event)"
              (uploadingChange)="onStepMediaUploadChange($event)"
              data-test="create-step-media"
            ></app-media-grid-uploader>
          </div>
          <input type="hidden" formControlName="mediaUrl" />

          <div class="create-diary-modal__editor">
            <app-editor
              [label]="'Décrivez cette étape'"
              [content]="stepEditorContent"
              (contentChange)="onStepEditorChange($event)"
            ></app-editor>
          </div>
        </section>

        @if (errorMessage) {
          <p class="create-diary-modal__error">{{ errorMessage }}</p>
        }

        <div class="create-diary-modal__footer">
          <app-button
            text="Retour"
            color="secondary"
            size="auto"
            radius="border_lg"
            htmlType="button"
            [isDisabled]="isSubmitting"
            (btnClick)="goBackToDiaryStage()"
            data-test="create-step-back"
          ></app-button>
          <app-button
            text="Annuler"
            color="secondary"
            size="auto"
            radius="border_lg"
            htmlType="button"
            [isDisabled]="isSubmitting"
            (btnClick)="handleCancel()"
            data-test="create-step-cancel"
          ></app-button>
          <app-button
            text="Enregistrer les changements"
            color="primary"
            size="auto"
            radius="border_lg"
            htmlType="submit"
            [isDisabled]="stepForm.invalid || isSubmitting || isStepMediaUploading"
            data-test="create-step-submit"
          ></app-button>
        </div>
      </form>
    }
  </div>
</div>

@if (isStepLocationModalOpen) {
  <app-location-picker-modal
    [initialCoordinates]="stepLocationInitialCoordinates"
    (cancel)="closeStepLocationModal()"
    (confirm)="handleStepLocationConfirm($event)"
  ></app-location-picker-modal>
}
