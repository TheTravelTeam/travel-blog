<div
  class="create-diary-modal"
  [class.create-diary-modal--mobile]="isMobile"
  data-test="create-diary-modal"
>
  <div class="create-diary-modal__panel">
    <div class="create-diary-modal__header">
      <div>
        <h2>
          @if (stage === 'diary') {
            @if (mode === 'edit') {
              Modifier le carnet
            } @else {
              Créer un carnet
            }
          } @else {
            Ajouter votre première étape
          }
        </h2>
        <p>
          @if (stage === 'diary') {
            @if (mode === 'edit') {
              Mettez à jour les informations principales de votre voyage.
            } @else {
              Saisissez les informations principales de votre voyage.
            }
          } @else {
            @let diaryTitle = diaryForm.get('title')?.value;
            @if (diaryTitle) {
              Première étape pour « {{ diaryTitle }} »
            } @else {
              Décrivez la première étape de votre voyage.
            }
          }
        </p>
      </div>
      <button
        type="button"
        class="create-diary-modal__close"
        (click)="handleCancel()"
        aria-label="Fermer"
      >
        <app-icon name="close"></app-icon>
      </button>
    </div>

    @if (stage === 'diary') {
      <form
        class="create-diary-modal__form"
        [formGroup]="diaryForm"
        (ngSubmit)="handleDiarySubmit()"
        data-test="create-diary-form"
      >
        <section class="create-diary-modal__section">
          <h3>Informations du carnet</h3>
          <div class="create-diary-modal__grid create-diary-modal__grid--diary">
            <app-text-input
              formControlName="title"
              label="Nom du voyage"
              placeholder="Le nom de votre voyage"
              [isRequired]="true"
              [errorMessage]="getDiaryControlError('title')"
              data-test="create-diary-title"
            ></app-text-input>

            <app-text-input
              formControlName="startDate"
              label="Date de début de voyage"
              placeholder="Choisissez la date de départ"
              type="date"
              [isRequired]="true"
              [errorMessage]="getDiaryControlError('startDate')"
              data-test="create-diary-period"
            ></app-text-input>
          </div>

          <div class="create-diary-modal__card create-diary-modal__card--stack">
            <div class="create-diary-modal__card-header">
              <app-icon name="travel_explore"></app-icon>
              <div>
                <p class="create-diary-modal__card-title">Image de couverture</p>
                <p class="create-diary-modal__card-subtitle">
                  Ajoutez un visuel pour présenter votre carnet.
                </p>
              </div>
            </div>

            <app-text-input
              formControlName="coverUrl"
              label="Adresse de l'image (URL)"
              placeholder="https://"
              data-test="create-diary-cover"
            ></app-text-input>

            <div class="create-diary-modal__upload">
              <app-media-grid-uploader
                #coverUploader
                class="create-diary-modal__cover-uploader"
                [items]="coverItems"
                [folder]="coverUploadFolder"
                [maxItems]="1"
                [autoUpload]="false"
                (itemsChange)="onCoverItemsChange($event)"
                (primaryChange)="onCoverPrimaryChange($event)"
                (uploadingChange)="onCoverUploadStateChange($event)"
                data-test="create-diary-cover-uploader"
              ></app-media-grid-uploader>
              <p class="create-diary-modal__upload-hint">
                Ajoutez une image (JPEG/PNG). Elle sera téléversée lors de la validation finale.
              </p>
              @if (isCoverUploading) {
                <p class="create-diary-modal__upload-status">Téléversement en cours…</p>
              }
              @if (coverUploadError) {
                <p class="create-diary-modal__upload-error">{{ coverUploadError }}</p>
              }
            </div>
          </div>

          <div class="create-diary-modal__options" role="group" aria-label="Paramètres du carnet">
            <label class="create-diary-modal__option" data-test="create-diary-private">
              <input type="checkbox" formControlName="isPrivate" />
              <span class="create-diary-modal__option-icon">
                <app-icon [name]="diaryForm.get('isPrivate')?.value ? 'lock' : 'public'"></app-icon>
              </span>
              <span class="create-diary-modal__option-content">
                <span class="create-diary-modal__option-title">
                  Carnet {{ diaryForm.get('isPrivate')?.value ? 'privé' : 'public' }}
                </span>
                <span class="create-diary-modal__option-hint">
                  Appuyez pour
                  {{ diaryForm.get('isPrivate')?.value ? 'le rendre public' : 'le rendre privé' }}.
                </span>
              </span>
            </label>
            <label class="create-diary-modal__option" data-test="create-diary-comments">
              <input type="checkbox" formControlName="canComment" />
              <span class="create-diary-modal__option-icon">
                <app-icon
                  [name]="
                    diaryForm.get('canComment')?.value ? 'chat_bubble' : 'chat_bubble_outline'
                  "
                ></app-icon>
              </span>
              <span class="create-diary-modal__option-content">
                <span class="create-diary-modal__option-title">
                  Commentaires {{ diaryForm.get('canComment')?.value ? 'activés' : 'désactivés' }}
                </span>
                <span class="create-diary-modal__option-hint">
                  Autorisez les lecteurs à réagir au carnet.
                </span>
              </span>
            </label>
          </div>

          <div class="create-diary-modal__editor">
            <app-editor
              [label]="'Décrivez votre voyage'"
              [content]="diaryEditorContent"
              (contentChange)="onDiaryEditorChange($event)"
            ></app-editor>
          </div>
        </section>

        <div class="create-diary-modal__footer">
          <app-button
            text="Annuler"
            color="secondary"
            size="auto"
            radius="border_lg"
            htmlType="button"
            [isDisabled]="isSubmitting"
            (btnClick)="handleCancel()"
            data-test="create-diary-cancel"
          ></app-button>
          @if (mode === 'edit') {
            <app-button
              text="Enregistrer le carnet"
              color="primary"
              size="auto"
              radius="border_lg"
              htmlType="submit"
              [isDisabled]="diaryForm.invalid || isSubmitting || isCoverUploading"
              data-test="create-diary-submit"
            ></app-button>
          } @else {
            <app-button
              text="Continuer"
              color="primary"
              size="auto"
              radius="border_lg"
              htmlType="submit"
              [isDisabled]="diaryForm.invalid || isSubmitting || isCoverUploading"
              data-test="create-diary-continue"
            ></app-button>
          }
        </div>
      </form>
    }

    @if (stage === 'step' && mode !== 'edit') {
      <app-create-step-form
        [availableThemes]="availableThemes"
        [isSubmitting]="isSubmitting"
        [errorMessage]="errorMessage"
        (submitStep)="handleStepFormSubmit($event)"
        (cancel)="handleStepFormCancel()"
        data-test="create-first-step-form"
      ></app-create-step-form>
    }
  </div>
</div>
