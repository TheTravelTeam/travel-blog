<form
  class="create-step"
  [formGroup]="stepForm"
  (ngSubmit)="handleSubmit()"
  data-test="create-step-form"
>
  <section class="create-step__section">
    <h3>Nouvelle étape</h3>
    <div class="create-step__grid">
      <app-text-input
        formControlName="title"
        label="Nom de l'étape"
        placeholder="Nom de l'étape"
        [isRequired]="true"
        [errorMessage]="getControlError('title')"
        data-test="step-form-title"
      ></app-text-input>

      <app-text-input
        formControlName="city"
        label="Ville"
        placeholder="Ville"
        [isRequired]="true"
        [errorMessage]="getControlError('city')"
        data-test="step-form-city"
      ></app-text-input>
      <app-text-input
        formControlName="country"
        label="Pays"
        placeholder="Pays"
        [isRequired]="true"
        [errorMessage]="getControlError('country')"
        data-test="step-form-country"
      ></app-text-input>
      <app-text-input
        formControlName="continent"
        label="Continent"
        placeholder="Continent"
        [isRequired]="true"
        [errorMessage]="getControlError('continent')"
        data-test="step-form-continent"
      ></app-text-input>

      <app-text-input
        formControlName="startDate"
        label="Début de l'étape"
        placeholder="Date et heure"
        type="datetime-local"
        data-test="step-form-start"
      ></app-text-input>

      <app-text-input
        formControlName="endDate"
        label="Fin de l'étape"
        placeholder="Date et heure"
        type="datetime-local"
        data-test="step-form-end"
      ></app-text-input>

      <app-select
        [itemsList]="availableThemes"
        label="Thème"
        placeholder="Choisissez un thème"
        [withMutipleSelect]="true"
        [selectedIds]="stepForm.get('themeIds')?.value ?? []"
        [disabled]="availableThemes.length === 0"
        (selectOnChange)="onThemeChange($event)"
        data-test="step-form-themes"
      ></app-select>

      <div class="create-step__location">
        <p class="create-step__location-label">Localisation</p>
        <div class="create-step__location-actions">
          <app-button
            text="Choisir sur la carte"
            color="secondary"
            size="auto"
            radius="border_lg"
            htmlType="button"
            (btnClick)="openLocationModal()"
            data-test="step-form-location"
          ></app-button>
          <span class="create-step__location-summary">{{
            locationEnrichmentSummary || selectedCoordinatesSummary
          }}</span>
        </div>
        @if (isGeocoding) {
          <p class="create-step__location-status">Recherche de l'adresse…</p>
        }
        @if (geocodingError) {
          <p class="create-step__location-error">{{ geocodingError }}</p>
        }
        @if (showLocationRequiredMessage) {
          <p class="create-step__location-error">
            Sélectionnez un point sur la carte pour continuer.
          </p>
        }
        <input type="hidden" formControlName="latitude" />
        <input type="hidden" formControlName="longitude" />
      </div>

      <app-media-grid-uploader
        [items]="mediaItems"
        [folder]="'travel-diaries/steps'"
        (itemsChange)="onMediaItemsChange($event)"
        (primaryChange)="onPrimaryMediaChange($event)"
        (uploadingChange)="onMediaUploadStateChange($event)"
        data-test="step-form-media"
      >
      </app-media-grid-uploader>
    </div>

    <div class="create-step__editor">
      <app-editor
        [label]="'Décrivez cette étape'"
        [content]="stepEditorContent"
        (contentChange)="onEditorChange($event)"
      ></app-editor>
    </div>
  </section>

  @if (errorMessage) {
    <p class="create-step__error">{{ errorMessage }}</p>
  }

  <div class="create-step__actions">
    <app-button
      text="Annuler"
      color="secondary"
      size="auto"
      radius="border_lg"
      htmlType="button"
      [isDisabled]="isSubmitting"
      (btnClick)="handleCancel()"
      data-test="step-form-cancel"
    ></app-button>
    <app-button
      text="Enregistrer l'étape"
      color="primary"
      size="auto"
      radius="border_lg"
      htmlType="submit"
      [isDisabled]="stepForm.invalid || isSubmitting || isMediaUploading"
      data-test="step-form-submit"
    ></app-button>
  </div>
</form>

@if (isLocationModalOpen) {
  <app-location-picker-modal
    [initialCoordinates]="locationInitialCoordinates"
    (cancel)="closeLocationModal()"
    (confirm)="handleLocationConfirm($event)"
  ></app-location-picker-modal>
}
