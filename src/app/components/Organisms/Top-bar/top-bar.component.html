<header
  class="topbar"
  [ngClass]="[
    bp.isMobile() ? 'is-mobile' : '',
    bp.isTablet() ? 'is-tablet' : '',
    bp.isDesktop() ? 'is-desktop' : '',
    (bp.isDesktop() || bp.isTablet()) && isHomeOrArticlePage ? 'topbar--desktop-home' : 'hola',
  ]"
>
  <div class="topbar__left">
    @if ((bp.isMobile() && isHomeOrArticlePage) || !bp.isMobile()) {
      <img src="/icon/logo_desktop.svg" alt="logo" class="topbar__logo" routerLink="/" />
    } @else {
      <button
        type="button"
        class="topbar__link topbar__link--back"
        (click)="onMobileBack()"
        aria-label="Retour"
      >
        <app-icon name="arrow_back" [size]="iconSize()" />
      </button>
    }
    @if (!bp.isMobileOrTablet() && !isHomeOrArticlePage) {
      <div class="topbar__center">
        <form class="search-bar" role="search" (submit)="onSearchSubmit($event)">
          <span class="search-bar__icon material-symbols-outlined">search</span>
          <input
            type="search"
            class="search-bar__input"
            placeholder="Rechercher un carnet ou une étape"
            autocomplete="off"
            [formControl]="searchControl"
            (focus)="onSearchFocus()"
            (blur)="onSearchBlur()"
            data-test="topbar-search-input"
          />
          @if (searchControl.value.trim().length) {
            <button
              type="button"
              class="search-bar__clear"
              aria-label="Effacer la recherche"
              (mousedown)="$event.preventDefault()"
              (click)="onClearSearch()"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          }
        </form>
        @if (shouldDisplaySearchPanel()) {
          <div class="topbar__search-results" (mousedown)="$event.preventDefault()">
            @if (isSearchLoading()) {
              <div class="topbar__search-status">Recherche en cours…</div>
            } @else if (searchError()) {
              <div class="topbar__search-status topbar__search-status--error">
                {{ searchError() }}
              </div>
            } @else if (hasSearchQuery() && !diaryResults().length && !stepResults().length) {
              <div class="topbar__search-status">Aucun résultat trouvé.</div>
            } @else {
              @if (diaryResults().length) {
                <div class="topbar__search-group">
                  <p class="topbar__search-group-title">Carnets</p>
                  <ul>
                    @for (result of diaryResults(); track result.id) {
                      <li>
                        <button
                          type="button"
                          (click)="onSearchResultClick(result)"
                          [attr.data-test]="'topbar-search-result-' + result.id"
                        >
                          <span class="topbar__search-label">{{ result.label }}</span>
                          @if (result.description) {
                            <span class="topbar__search-description">{{ result.description }}</span>
                          }
                        </button>
                      </li>
                    }
                  </ul>
                </div>
              }
              @if (stepResults().length) {
                <div class="topbar__search-group">
                  <p class="topbar__search-group-title">Étapes</p>
                  <ul>
                    @for (result of stepResults(); track result.id) {
                      <li>
                        <button
                          type="button"
                          (click)="onSearchResultClick(result)"
                          [attr.data-test]="'topbar-search-result-' + result.id"
                        >
                          <span class="topbar__search-label">{{ result.label }}</span>
                          <span class="topbar__search-description">
                            @if (result.diaryTitle) {
                              {{ result.diaryTitle }} ·
                            }
                            {{ result.description ?? 'Voir le détail' }}
                          </span>
                        </button>
                      </li>
                    }
                  </ul>
                </div>
              }
            }
          </div>
        }
      </div>
    }
  </div>

  <div class="topbar__right">
    @if (bp.isDesktop() ) {
      <nav class="topbar__menu">
        <a routerLink="/travels" class="topbar__link">
          <app-icon name="language" [size]="iconSize()" />
          Mappemonde
        </a>
        <a routerLink="/articles" class="topbar__link">
          <app-icon name="map_search" [size]="iconSize()" />
          Articles
        </a>
        @if (canDisplayDiariesLink) {
          <a
            [routerLink]="['/travels/users', currentUserId()]"
            class="topbar__link"
            data-test="topbar-my-diaries"
          >
            <app-icon name="import_contacts" [size]="iconSize()" />
            Mes carnets
          </a>
        }
      </nav>
      <div class="topbar__actions">
        @if (isAuthenticated()) {
          <a routerLink="/me" class="topbar__profile" data-test="topbar-me">
            <app-avatar
              [label]="avatarLabel()"
              [picture]="avatarPicture()"
              [size]="bp.isMobileOrTablet() ? 'compact' : 'default'"
            />
          </a>
          <app-button
            [type]="'standard'"
            [size]="btnSize()"
            color="secondary"
            text="Déconnexion"
            (btnClick)="onLogout()"
            data-test="topbar-logout"
          />
        } @else {
          <app-button
            [type]="'standard'"
            [size]="btnSize()"
            color="secondary"
            text="Connexion"
            (btnClick)="onNavigateToLogin()"
          />
        }
      </div>
    } @else {
      <nav class="topbar__menu">
        <a routerLink="/travels" class="topbar__link__mobile">
          <app-icon name="language" [size]="iconSize()" />
        </a>
        <a routerLink="/articles" class="topbar__link__mobile">
          <app-icon name="map_search" [size]="iconSize()" />
        </a>
        @if (canDisplayDiariesLink) {
          <a
            [routerLink]="['/travels/users', currentUserId()]"
            class="topbar__link__mobile"
            data-test="topbar-my-diaries"
          >
            <app-icon name="import_contacts" [size]="iconSize()" />
          </a>
        }
      </nav>
      <div class="topbar__actions">
        @if (isAuthenticated()) {
          <a routerLink="/me" class="topbar__profile">
            <app-avatar
              [label]="avatarLabel()"
              [picture]="avatarPicture()"
              size="compact"
            />
          </a>
          <div class="topbar__logout" data-test="topbar-logout">
            <button
              type="button"
              class="topbar__logout-btn"
              (click)="onLogout()"
              aria-label="Se déconnecter"
            >
              <app-icon name="power_settings_new" [size]="logoutIconSize()" />
            </button>
          </div>
        } @else {
          <app-button
            [type]="'standard'"
            size="sm"
            color="secondary"
            text="Connexion"
            (btnClick)="onNavigateToLogin()"
          />
        }
      </div>
    }
  </div>
</header>
